# REMOVED: workflow 'Release APK'
# Le workflow qui buildait l'APK et mettait à jour GitHub Pages a été désactivé.
# Si besoin, il peut être ré-introduit manuellement, mais par défaut il est désactivé.


      - name: Upload APK as workflow artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Create or update release in target repo and upload APK
        env:
          GH_RELEASES_TOKEN: ${{ secrets.GH_RELEASES_TOKEN }}
          TAG: ${{ env.TAG }}
          TARGET: ${{ env.TARGET_RELEASE_REPO }}
        run: |
          set -e
          apk_path=build/app/outputs/flutter-apk/app-release.apk
          if [ ! -f "$apk_path" ]; then
            echo "APK not found at $apk_path"; exit 1;
          fi

          # Try to create release
          create_resp=$(curl -s -X POST -H "Authorization: token $GH_RELEASES_TOKEN" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET/releases \
            -d "{\"tag_name\": \"$TAG\", \"name\": \"$TAG\", \"body\": \"Automated release from $GITHUB_REPOSITORY\", \"draft\": false, \"prerelease\": false}")

          release_id=$(echo "$create_resp" | jq -r '.id // empty')
          if [ -z "$release_id" ]; then
            echo "Create failed or release exists; fetching existing release by tag"
            release_resp=$(curl -s -H "Authorization: token $GH_RELEASES_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$TARGET/releases/tags/$TAG)
            release_id=$(echo "$release_resp" | jq -r '.id // empty')
            if [ -z "$release_id" ]; then
              echo "Failed to create or find release for tag $TAG"; echo "$create_resp"; exit 1;
            fi
          fi

          # upload asset
          upload_url=$(curl -s -H "Authorization: token $GH_RELEASES_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$TARGET/releases/$release_id | jq -r '.upload_url')
          upload_url="${upload_url%%\{*}?name=app-release.apk"
          curl -s -X POST -H "Authorization: token $GH_RELEASES_TOKEN" -H "Content-Type: application/octet-stream" --data-binary @"$apk_path" "$upload_url&name=app-release.apk" || echo "Upload failed or asset already exists"

      - name: Publish version.json to pages repo
        env:
          GH_RELEASES_TOKEN: ${{ secrets.GH_RELEASES_TOKEN }}
          TAG: ${{ env.TAG }}
          TARGET: ${{ env.TARGET_RELEASE_REPO }}
        run: |
          set -e
          echo "Publishing web_redirect/version.json to Espoir-oussa/payrent-releases"
          git clone "https://x-access-token:${GH_RELEASES_TOKEN}@github.com/Espoir-oussa/payrent-releases.git" tmp-pages
          cd tmp-pages
          # choose gh-pages if exists, otherwise main
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git checkout gh-pages
          else
            git checkout main
          fi
          cp ../web_redirect/version.json ./version.json
          git add version.json
          git commit -m "chore(pages): update version.json for ${TAG}" || echo "No changes to pages"
          git push origin HEAD
